# Qoder foobar æ’ä»¶æ¶æ„è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ å½“å‰é—®é¢˜åˆ†æ

å½“å‰è®¾è®¡çš„é—®é¢˜ï¼š
1. **SDKè€¦åˆ**: åŸç”ŸåŠŸèƒ½ä¸foobar2000å…¼å®¹å±‚æ··åˆ
2. **æ¥å£æ··æ·†**: service_baseæ¥å£ç›´æ¥ç»§æ‰¿è‡ªfoobar2000
3. **æ‰©å±•æ€§å·®**: éš¾ä»¥æ”¯æŒå…¶ä»–æ’­æ”¾å™¨æ’ä»¶æ ¼å¼
4. **ç»´æŠ¤å›°éš¾**: ä¸¤å¥—é€»è¾‘äº¤ç»‡åœ¨ä¸€èµ·

---

## ğŸ¯ æ¨èæ¶æ„ï¼šåˆ†å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨å±‚                        â”‚
â”‚         Qoder foobar Music Player           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ’ä»¶ç®¡ç†å™¨                      â”‚
â”‚    â€¢ æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†                       â”‚
â”‚    â€¢ æ’ä»¶æ³¨å†Œè¡¨                            â”‚
â”‚    â€¢ æ’ä»¶åŠ è½½/å¸è½½                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ’ä»¶é€‚é…å™¨å±‚                      â”‚
â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åŸç”Ÿæ’ä»¶é€‚é… â”‚  â”‚ foobar2000å…¼å®¹é€‚é…   â”‚   â”‚
â”‚  â”‚ å™¨          â”‚  â”‚ å™¨                  â”‚   â”‚
â”‚  â”‚             â”‚  â”‚                     â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚Audio    â”‚ â”‚  â”‚ â”‚ foobar2000 SDK  â”‚ â”‚   â”‚
â”‚  â”‚ â”‚Decoder  â”‚ â”‚  â”‚ â”‚ å…¼å®¹å±‚          â”‚ â”‚   â”‚
â”‚  â”‚ â”‚Plugin   â”‚ â”‚  â”‚ â”‚                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚API      â”‚ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚                     â”‚   â”‚
â”‚  â”‚             â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”‚Plugin           â”‚ â”‚   â”‚
â”‚  â”‚ â”‚DSP      â”‚ â”‚  â”‚ â”‚Wrapper          â”‚ â”‚   â”‚
â”‚  â”‚ â”‚Plugin   â”‚ â”‚  â”‚ â”‚                 â”‚ â”‚   â”‚
â”‚  â”‚ â”‚API      â”‚ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Qoder foobar SDK                 â”‚
â”‚  â€¢ æ ¸å¿ƒæ¥å£å®šä¹‰                            â”‚
â”‚  â€¢ æ’ä»¶åŸºç±»                                â”‚
â”‚  â€¢ å·¥å…·å‡½æ•°                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ç¬¬ä¸€å±‚ï¼šQoder foobar åŸç”ŸSDK

### æ ¸å¿ƒæ¥å£è®¾è®¡

```cpp
// qoder_plugin_sdk.h
#pragma once

#include <cstdint>
#include <string>
#include <vector>
#include <memory>

namespace qoder {

// æ’ä»¶ä¿¡æ¯ç»“æ„
struct PluginInfo {
    std::string name;
    std::string version;
    std::string author;
    std::string description;
    uint32_t api_version;
};

// éŸ³é¢‘æ ¼å¼
struct AudioFormat {
    int sample_rate;
    int channels;
    int bits_per_sample;
    bool is_float;
};

// éŸ³é¢‘ç¼“å†²åŒº
struct AudioBuffer {
    float* data;
    int frames;
    int channels;
};

// æ’ä»¶åŸºç±»
class IPlugin {
public:
    virtual ~IPlugin() = default;

    // æ’ä»¶ç”Ÿå‘½å‘¨æœŸ
    virtual bool initialize() = 0;
    virtual void finalize() = 0;

    // è·å–æ’ä»¶ä¿¡æ¯
    virtual PluginInfo get_info() const = 0;
};

// è¾“å…¥è§£ç å™¨æ¥å£
class IAudioDecoder : public IPlugin {
public:
    virtual ~IAudioDecoder() = default;

    // æ ¼å¼æ”¯æŒ
    virtual bool can_decode(const std::string& file_path) = 0;
    virtual std::vector<std::string> get_supported_extensions() = 0;

    // è§£ç æ“ä½œ
    virtual bool open(const std::string& file_path) = 0;
    virtual int decode(AudioBuffer& buffer, int max_frames) = 0;
    virtual bool seek(int64_t sample_pos) = 0;
    virtual void close() = 0;

    // éŸ³é¢‘ä¿¡æ¯
    virtual AudioFormat get_format() const = 0;
    virtual int64_t get_length() const = 0;
    virtual std::string get_metadata(const std::string& key) = 0;
};

// DSPæ•ˆæœå™¨æ¥å£
class IDSPProcessor : public IPlugin {
public:
    virtual ~IDSPProcessor() = default;

    // å¤„ç†é…ç½®
    virtual bool configure(const AudioFormat& input_format,
                          const AudioFormat& output_format) = 0;

    // å¤„ç†éŸ³é¢‘
    virtual int process(const AudioBuffer& input,
                       AudioBuffer& output) = 0;

    // å‚æ•°æ§åˆ¶
    virtual void set_parameter(const std::string& name, double value) = 0;
    virtual double get_parameter(const std::string& name) = 0;
};

// è¾“å‡ºè®¾å¤‡æ¥å£
class IAudioOutput : public IPlugin {
public:
    virtual ~IAudioOutput() = default;

    // è®¾å¤‡ç®¡ç†
    virtual std::vector<std::string> get_devices() = 0;
    virtual bool open_device(const std::string& device_id,
                            const AudioFormat& format) = 0;
    virtual void close_device() = 0;

    // éŸ³é¢‘è¾“å‡º
    virtual int write(const AudioBuffer& buffer) = 0;
    virtual int get_latency() = 0;
    virtual void flush() = 0;
};

// æ’ä»¶å·¥å‚
template<typename Interface>
class IPluginFactory {
public:
    virtual ~IPluginFactory() = default;
    virtual std::unique_ptr<Interface> create() = 0;
    virtual PluginInfo get_info() const = 0;
};

// æ’ä»¶å¯¼å‡ºå®
#define QODER_EXPORT_PLUGIN(PluginClass, FactoryClass) \
    extern "C" { \
        QODER_PLUGIN_API IPluginFactory* create_plugin_factory() { \
            return new FactoryClass(); \
        } \
    }

} // namespace qoder
```

### æ’ä»¶ç¤ºä¾‹

```cpp
// flac_decoder_plugin.cpp
#include "qoder_plugin_sdk.h"

class FLACDecoderPlugin : public qoder::IAudioDecoder {
private:
    // FLACè§£ç å™¨å†…éƒ¨çŠ¶æ€

public:
    bool initialize() override {
        // åˆå§‹åŒ–FLACåº“
        return true;
    }

    void finalize() override {
        // æ¸…ç†èµ„æº
    }

    qoder::PluginInfo get_info() const override {
        return {
            "FLAC Decoder",
            "1.0.0",
            "Qoder Team",
            "FLAC lossless audio decoder",
            QODER_PLUGIN_API_VERSION
        };
    }

    bool can_decode(const std::string& file_path) override {
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºFLAC
        return file_path.ends_with(".flac");
    }

    // ... å…¶ä»–æ¥å£å®ç°
};

class FLACDecoderFactory : public qoder::IPluginFactory<qoder::IAudioDecoder> {
public:
    std::unique_ptr<qoder::IAudioDecoder> create() override {
        return std::make_unique<FLACDecoderPlugin>();
    }

    qoder::PluginInfo get_info() const override {
        return {
            "FLAC Decoder Factory",
            "1.0.0",
            "Qoder Team",
            "Factory for FLAC decoder plugin",
            QODER_PLUGIN_API_VERSION
        };
    }
};

// å¯¼å‡ºæ’ä»¶
QODER_EXPORT_PLUGIN(FLACDecoderPlugin, FLACDecoderFactory)
```

---

## ğŸ”„ ç¬¬äºŒå±‚ï¼šfoobar2000 å…¼å®¹é€‚é…å™¨

### é€‚é…å™¨è®¾è®¡

```cpp
// foobar_adapter.h
#pragma once

#include "../qoder_plugin_sdk.h"
#include "foobar2000.h"
#include <unordered_map>

namespace qoder::compat {

// foobar2000 åˆ° Qoder æ¥å£çš„é€‚é…å™¨
class FoobarDecoderAdapter : public qoder::IAudioDecoder {
private:
    foobar2000::service_ptr_t<foobar2000::input_decoder> foobar_decoder_;
    std::string file_path_;

public:
    explicit FoobarDecoderAdapter(foobar2000::input_decoder* decoder)
        : foobar_decoder_(decoder) {}

    // å®ç° Qoder æ¥å£
    bool can_decode(const std::string& file_path) override {
        return foobar_decoder_->can_decode(file_path.c_str());
    }

    bool open(const std::string& file_path) override {
        file_path_ = file_path;
        return foobar_decoder_->open(file_path.c_str()) == 0;
    }

    int decode(qoder::AudioBuffer& buffer, int max_frames) override {
        // è½¬æ¢ç¼“å†²åŒºæ ¼å¼
        return foobar_decoder_->decode(buffer.data, max_frames * sizeof(float));
    }

    // ... å…¶ä»–é€‚é…æ–¹æ³•
};

// foobar2000 æ’ä»¶åŒ…è£…å™¨
class FoobarPluginWrapper {
private:
    void* library_handle_;
    std::vector<std::unique_ptr<qoder::IAudioDecoder>> adapters_;

public:
    bool load_plugin(const std::string& path) {
        // åŠ è½½foobar2000æ’ä»¶
        library_handle_ = dlopen(path.c_str(), RTLD_LAZY);
        if (!library_handle_) return false;

        // æšä¸¾æ’ä»¶æä¾›çš„æœåŠ¡
        enumerate_services();

        return true;
    }

    std::vector<std::unique_ptr<qoder::IAudioDecoder>> get_decoders() {
        // è¿”å›é€‚é…åçš„è§£ç å™¨
        std::vector<std::unique_ptr<qoder::IAudioDecoder>> result;
        for (auto& adapter : adapters_) {
            result.emplace_back(std::move(adapter));
        }
        return result;
    }
};

} // namespace qoder::compat
```

---

## ğŸ›ï¸ ç¬¬ä¸‰å±‚ï¼šæ’ä»¶ç®¡ç†å™¨

### ç»Ÿä¸€æ’ä»¶ç®¡ç†

```cpp
// plugin_manager.h
#pragma once

#include "qoder_plugin_sdk.h"
#include "compat/foobar_adapter.h"
#include <vector>
#include <unordered_map>
#include <memory>

namespace qoder {

class PluginManager {
private:
    // åŸç”Ÿæ’ä»¶
    std::unordered_map<std::string, std::unique_ptr<IPluginFactory>> native_plugins_;

    // foobar2000æ’ä»¶
    std::vector<std::unique_ptr<compat::FoobarPluginWrapper>> foobar_plugins_;

    // æ³¨å†Œçš„è§£ç å™¨
    std::vector<std::unique_ptr<IAudioDecoder>> decoders_;

public:
    // åŠ è½½åŸç”Ÿæ’ä»¶
    bool load_native_plugin(const std::string& path);

    // åŠ è½½foobar2000æ’ä»¶
    bool load_foobar_plugin(const std::string& path);

    // æ‰¹é‡åŠ è½½
    void load_plugins_from_directory(const std::string& directory);

    // è·å–è§£ç å™¨
    std::unique_ptr<IAudioDecoder> get_decoder(const std::string& file_path);

    // è·å–æ‰€æœ‰æ”¯æŒçš„æ ¼å¼
    std::vector<std::string> get_supported_formats();

    // æ’ä»¶ä¿¡æ¯
    std::vector<PluginInfo> get_plugin_list();
};

} // namespace qoder
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
Qoder_foobar/
â”œâ”€â”€ sdk/                         # Qoder foobar åŸç”ŸSDK
â”‚   â”œâ”€â”€ qoder_plugin_sdk.h      # æ ¸å¿ƒæ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ qoder_plugin_api.h      # å¹³å°ç›¸å…³å®šä¹‰
â”‚   â””â”€â”€ examples/               # æ’ä»¶ç¤ºä¾‹
â”‚       â”œâ”€â”€ simple_decoder/
â”‚       â””â”€â”€ dsp_plugin/
â”œâ”€â”€ compat/                      # å…¼å®¹å±‚
â”‚   â”œâ”€â”€ foobar2000/             # foobar2000å…¼å®¹
â”‚   â”‚   â”œâ”€â”€ foobar_adapter.h   # é€‚é…å™¨å¤´æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ foobar_adapter.cpp # é€‚é…å™¨å®ç°
â”‚   â”‚   â””â”€â”€ foobar_sdk/        # foobar2000 SDKå‰¯æœ¬
â”‚   â””â”€â”€ other_players/          # å…¶ä»–æ’­æ”¾å™¨å…¼å®¹(æœªæ¥)
â”œâ”€â”€ core/                        # æ ¸å¿ƒç³»ç»Ÿ
â”‚   â”œâ”€â”€ plugin_manager.h       # æ’ä»¶ç®¡ç†å™¨
â”‚   â”œâ”€â”€ plugin_manager.cpp     #
â”‚   â””â”€â”€ plugin_registry.h      # æ’ä»¶æ³¨å†Œè¡¨
â””â”€â”€ src/                         # ä¸»ç¨‹åº
    â””â”€â”€ music_player.cpp        # ä½¿ç”¨æ–°SDKçš„éŸ³ä¹æ’­æ”¾å™¨
```

---

## ğŸ”„ æ’ä»¶åŠ è½½æµç¨‹

```mermaid
graph TD
    A[å¯åŠ¨æ’­æ”¾å™¨] --> B[åˆå§‹åŒ–æ’ä»¶ç®¡ç†å™¨]
    B --> C[æ‰«ææ’ä»¶ç›®å½•]
    C --> D{æ–‡ä»¶ç±»å‹?}
    D -->|åŸç”Ÿ.so/.dll| E[åŠ è½½åŸç”Ÿæ’ä»¶]
    D -->|foobar2000æ’ä»¶| F[é€šè¿‡å…¼å®¹å±‚åŠ è½½]
    E --> G[æ³¨å†Œæ’ä»¶å·¥å‚]
    F --> H[åˆ›å»ºé€‚é…å™¨]
    H --> G
    G --> I[æ„å»ºè§£ç å™¨åˆ—è¡¨]
    I --> J[å‡†å¤‡æ’­æ”¾]
```

---

## ğŸ¯ ä¼˜åŠ¿

1. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**
   - åŸç”ŸSDKç‹¬ç«‹äºä»»ä½•æ’­æ”¾å™¨
   - å…¼å®¹å±‚æ˜¯å¯é€‰çš„é€‚é…å™¨
   - æ’ä»¶ç®¡ç†å™¨ç»Ÿä¸€ç®¡ç†

2. **æ˜“äºæ‰©å±•**
   - æ·»åŠ æ–°çš„å…¼å®¹å±‚ä¸éœ€è¦ä¿®æ”¹SDK
   - å¯ä»¥æ”¯æŒå¤šç§æ’ä»¶æ ¼å¼
   - æ’ä»¶å¼€å‘è€…åªéœ€å…³æ³¨åŸç”Ÿæ¥å£

3. **æ›´å¥½çš„æ€§èƒ½**
   - åŸç”Ÿæ’ä»¶é›¶å¼€é”€
   - å…¼å®¹å±‚åªåœ¨éœ€è¦æ—¶åŠ è½½
   - å‡å°‘ä¸å¿…è¦çš„è½¬æ¢

4. **ç»´æŠ¤æ€§å¥½**
   - å„å±‚ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
   - å…¼å®¹å±‚é—®é¢˜ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
   - ä¾¿äºå®šä½å’Œä¿®å¤é—®é¢˜

---

## ğŸ“ å®æ–½å»ºè®®

1. **ç¬¬ä¸€é˜¶æ®µ**: å®ç°åŸç”ŸSDK
   - å®šä¹‰æ ¸å¿ƒæ¥å£
   - åˆ›å»ºç¤ºä¾‹æ’ä»¶
   - å®ç°æ’ä»¶ç®¡ç†å™¨

2. **ç¬¬äºŒé˜¶æ®µ**: è¿ç§»ç°æœ‰åŠŸèƒ½
   - å°†ç°æœ‰è§£ç å™¨æ”¹ä¸ºåŸç”Ÿæ’ä»¶
   - æ›´æ–°éŸ³ä¹æ’­æ”¾å™¨ä½¿ç”¨æ–°SDK

3. **ç¬¬ä¸‰é˜¶æ®µ**: å®ç°å…¼å®¹å±‚
   - å¼€å‘foobar2000é€‚é…å™¨
   - æµ‹è¯•å…¼å®¹æ€§

4. **ç¬¬å››é˜¶æ®µ**: ä¼˜åŒ–å’Œæ‰©å±•
   - æ€§èƒ½ä¼˜åŒ–
   - æ·»åŠ å…¶ä»–æ’­æ”¾å™¨å…¼å®¹
   - å®Œå–„æ–‡æ¡£

---

*è¿™ä¸ªè®¾è®¡è®©Qoder foobaræ—¢æœ‰äº†å¼ºå¤§çš„åŸç”Ÿæ’ä»¶èƒ½åŠ›ï¼Œåˆä¿æŒäº†å¯¹foobar2000ç”Ÿæ€çš„å…¼å®¹æ€§ã€‚*